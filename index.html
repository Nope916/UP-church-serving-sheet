<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>教會事奉表</title>

  <style>
    .row-hit td { background: #E8F2FF; }
    td.highlight { background: #eed85a; font-weight:600; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
      padding:10px;
      background:#fff;
      position:sticky;
      top:0;
      z-index:20;
      border-bottom:1px solid #eee;
    }
    .controls select,
    .controls input,
    .controls button{
      font-size:16px;
      padding:10px 12px;
    }

    .table-wrap{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid #eee;
      border-radius:10px;
    }
    table{
      border-collapse:collapse;
      width:max-content;
      min-width:100%;
    }
    th, td{
      border:1px solid #ddd;
      padding:10px 12px;
      white-space:nowrap;
      text-align:left;
    }
    thead th{
      background:#f6f6f6;
    }
  </style>
</head>

<body>

  <div class="controls">
    <label>
      選擇同工：
      <select id="personSelect">
        <option value="">（請選擇）</option>
      </select>
    </label>

    <label>
      搜尋：
      <input id="personFilter" type="text" placeholder="輸入任一字…" autocomplete="off">
    </label>

    <button id="clearBtn" type="button">清除</button>

    <span id="occCount">出現次數：0</span>
    <span id="dayCount">有幾天：0</span>
    <span id="hitPeople" style="margin-left:8px;">命中人數：0</span>
  </div>

  <div class="table-wrap">
    <table id="roster">
      <thead>
        <tr>
          <th>日期</th>
          <th>會前禱告</th>
          <th>講員</th>
          <th>敬拜主領</th>
          <th>敬拜Vocal</th>
          <th>樂團</th>
          <th>報告</th>
          <th>擘餅</th>
          <th>投影</th>
          <th>總音控</th>
          <th>架設直播</th>
          <th>招待奉獻</th>
          <th>兒主老師</th>
          <th>備註</th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>2026-01-04</td>
          <td>盈君</td>
          <td>高詩清牧師</td>
          <td>文祺、以帆</td>
          <td>小以琳</td>
          <td>琴:伶安｜吉:宗明｜鼓:睿甫｜斯:季如</td>
          <td>昶翰</td>
          <td>盈君、宗明</td>
          <td>凱鈞</td>
          <td>至忠</td>
          <td>莞茹</td>
          <td>樂樂、玠勻</td>
          <td>可馨</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-01-11</td>
          <td>雅親</td>
          <td>高詩清牧師</td>
          <td>可馨、宗明</td>
          <td>盈君</td>
          <td>琴:遠晟｜吉:昶翰｜鼓:儇齊｜斯:響萱</td>
          <td>文祺</td>
          <td></td>
          <td>薰聲</td>
          <td>欣仁</td>
          <td>萬隆</td>
          <td>季如</td>
          <td>凱鈞</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-01-18</td>
          <td>莞茹</td>
          <td>李惠知牧師</td>
          <td>以帆、至忠、儇齊、為聖</td>
          <td></td>
          <td>琴:可馨｜吉:紹華｜鼓:睿甫｜斯:至忠</td>
          <td>宗明</td>
          <td></td>
          <td>莞茹</td>
          <td>宇睿</td>
          <td>薰聲</td>
          <td>盈君</td>
          <td>昶翰</td>
          <td>牧養同工會 15:00</td>
        </tr>

        <tr>
          <td>2026-01-25</td>
          <td>季如</td>
          <td>謝尚儒傳道</td>
          <td>伶安</td>
          <td>孟璇、昶翰</td>
          <td>琴:睿甫｜吉:文祺｜鼓:為聖｜斯:以帆</td>
          <td>惠知</td>
          <td></td>
          <td>湘絨</td>
          <td>至忠</td>
          <td>欣仁</td>
          <td>雅親</td>
          <td>盈君</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-02-01</td>
          <td>孟璇</td>
          <td>高詩清牧師</td>
          <td>文祺</td>
          <td>紹華、榕榕</td>
          <td>琴:遠晟｜吉:以帆｜鼓:儇齊｜斯:響萱</td>
          <td>昶翰</td>
          <td>昶翰、莞茹</td>
          <td>欣仁</td>
          <td>睿甫</td>
          <td>萬隆</td>
          <td>湘絨</td>
          <td>宇睿</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-02-08</td>
          <td>凱鈞</td>
          <td>李惠知牧師</td>
          <td>可馨、儇齊</td>
          <td>愛真、樂樂、玠勻、予希、宜佑、雅筑</td>
          <td>琴:為聖｜吉:紹華｜鼓:睿甫｜斯:季如</td>
          <td>文祺</td>
          <td></td>
          <td>盈君</td>
          <td>萬隆</td>
          <td>欣仁</td>
          <td>孟璇</td>
          <td>莞茹</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-02-15</td>
          <td colspan="13">春節主日（暫停）</td>
        </tr>

        <tr>
          <td>2026-02-22</td>
          <td>雅親</td>
          <td>蘇麗容牧師</td>
          <td>宗明</td>
          <td>凱鈞、盈君</td>
          <td>琴:可馨｜吉:文祺｜鼓:為聖｜斯:以帆</td>
          <td>惠知</td>
          <td></td>
          <td>薰聲</td>
          <td>欣仁</td>
          <td>莞茹</td>
          <td>季如</td>
          <td>小以琳</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-01</td>
          <td>盈君</td>
          <td>高詩清牧師</td>
          <td>文祺、以帆</td>
          <td>小以琳</td>
          <td>琴:伶安｜吉:宗明｜鼓:睿甫｜斯:季如</td>
          <td>昶翰</td>
          <td></td>
          <td>凱鈞</td>
          <td>至忠</td>
          <td>莞茹</td>
          <td>樂樂、玠勻</td>
          <td>可馨</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-08</td>
          <td>雅親</td>
          <td>高詩清牧師</td>
          <td>可馨、宗明</td>
          <td>盈君</td>
          <td>琴:遠晟｜吉:昶翰｜鼓:儇齊｜斯:響萱</td>
          <td>文祺</td>
          <td>雅親、宗明</td>
          <td>薰聲</td>
          <td>欣仁</td>
          <td>萬隆</td>
          <td>季如</td>
          <td>凱鈞</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-15</td>
          <td>莞茹</td>
          <td>李惠知牧師</td>
          <td>以帆、至忠、儇齊、為聖</td>
          <td></td>
          <td>琴:可馨｜吉:紹華｜鼓:睿甫｜斯:至忠</td>
          <td>宗明</td>
          <td></td>
          <td>莞茹</td>
          <td>宇睿</td>
          <td>薰聲</td>
          <td>盈君</td>
          <td>昶翰</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-22</td>
          <td>季如</td>
          <td>謝尚儒傳道</td>
          <td>伶安</td>
          <td>孟璇、昶翰</td>
          <td>琴:睿甫｜吉:文祺｜鼓:為聖｜斯:以帆</td>
          <td>惠知</td>
          <td></td>
          <td>湘絨</td>
          <td>至忠</td>
          <td>欣仁</td>
          <td>雅親</td>
          <td>盈君</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-29</td>
          <td>孟璇</td>
          <td>高詩清牧師</td>
          <td>文祺</td>
          <td>紹華、榕榕</td>
          <td>琴:遠晟｜吉:以帆｜鼓:儇齊｜斯:響萱</td>
          <td>昶翰</td>
          <td></td>
          <td>欣仁</td>
          <td>睿甫</td>
          <td>萬隆</td>
          <td>湘絨</td>
          <td>宇睿</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>

<script>
const table = document.getElementById("roster");
const select = document.getElementById("personSelect");
const filterInput = document.getElementById("personFilter");
const clearBtn = document.getElementById("clearBtn");
const occCount = document.getElementById("occCount");
const dayCount = document.getElementById("dayCount");
const hitPeople = document.getElementById("hitPeople");

function norm(s){
  return String(s||"").replace(/\s+/g," ").trim();
}
function escapeRegExp(s){
  return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
}

function extractNamesFromCell(text, isBand){
  const t = norm(text);
  if(!t) return [];
  const out = [];

  if(isBand){
    t.split(/[｜|]/).forEach(part=>{
      const seg = part.split(/[:：]/);
      if(seg.length >= 2){
        const name = norm(seg.slice(1).join(":"));
        if(name) out.push(name);
      }
    });
  }else{
    t.split(/[、,，/｜]/).forEach(n=>{
      n = norm(n);
      if(n) out.push(n);
    });
  }
  return out;
}

function cellHasName(text, name){
  const t = norm(text);
  const n = norm(name);
  if(!t || !n) return false;

  if(t.includes(":") || t.includes("：")){
    return t.split(/[｜|]/).some(part=>{
      const seg = part.split(/[:：]/);
      return seg.length >= 2 && norm(seg.slice(1).join(":")) === n;
    });
  }

  if(t === n) return true;
  const re = new RegExp(`(^|[、,，/\\s｜])${escapeRegExp(n)}([、,，/\\s｜]|$)`);
  return re.test(t);
}

function clearHighlight(){
  table.querySelectorAll(".highlight").forEach(td=>td.classList.remove("highlight"));
  table.querySelectorAll("tbody tr").forEach(tr=>tr.classList.remove("row-hit"));
  occCount.textContent = "出現次數：0";
  dayCount.textContent = "有幾天：0";
  hitPeople.textContent = "命中人數：0";
}

function getHeaders(){
  return Array.from(table.querySelectorAll("thead th")).map(th => norm(th.textContent));
}

function buildNameList(){
  const headers = getHeaders();
  const set = new Set();

  table.querySelectorAll("tbody tr").forEach(tr=>{
    const tds = Array.from(tr.children).filter(el => el.tagName === "TD");
    if(!tds.length) return;

    // 跳過春節暫停列（colspan 很大）
    if(tds.length >= 2 && (tds[1].colSpan || 1) > 1) return;

    let col = 0;
    for(const td of tds){
      const span = td.colSpan || 1;
      const header = headers[col] || "";
      const text = td.textContent;

      if(header === "日期" || header === "講員" || header === "備註"){
        col += span;
        continue;
      }

      const t = norm(text);
      if(t.includes("暫停") || t.includes("春節主日")){
        col += span;
        continue;
      }

      if(header === "樂團"){
        extractNamesFromCell(text, true).forEach(n => set.add(n));
      }else{
        extractNamesFromCell(text, false).forEach(n => set.add(n));
      }

      col += span;
    }
  });

  return Array.from(set).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
}

const allNames = buildNameList();

/* 建立 select 名單（全名單，不跟 input 互相綁死） */
function fillSelect(){
  while(select.options.length > 1) select.remove(1);
  allNames.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}
fillSelect();

/* 你要的：打一個字就 highlight 多個人 */
function applyHighlightMany(names){
  clearHighlight();
  const list = Array.from(new Set((names||[]).map(norm).filter(Boolean)));
  if(!list.length) return;

  let occ = 0;
  const days = new Set();

  table.querySelectorAll("tbody tr").forEach(tr=>{
    const tds = Array.from(tr.querySelectorAll("td"));
    if(!tds.length) return;

    const date = norm(tds[0].textContent);
    let hitRow = false;

    // 從第 2 格開始掃（跳過日期）
    for(let i=1;i<tds.length;i++){
      const td = tds[i];
      const text = td.textContent;

      // 任何一個名字命中就標記該格
      let hitCell = false;
      for(const name of list){
        if(cellHasName(text, name)){
          hitCell = true;
          break;
        }
      }

      if(hitCell){
        td.classList.add("highlight");
        occ++;
        hitRow = true;
      }
    }

    if(hitRow){
      tr.classList.add("row-hit");
      if(date) days.add(date);
    }
  });

  occCount.textContent = `出現次數：${occ}`;
  dayCount.textContent = `有幾天：${days.size}`;
  hitPeople.textContent = `命中人數：${list.length}`;
}

/* input：即時搜尋（含任一字就算） */
filterInput.addEventListener("input", () => {
  const q = norm(filterInput.value).toLowerCase();

  // 空字串 -> 清掉
  if(!q){
    select.value = "";
    clearHighlight();
    return;
  }

  // 找出「名字包含 q」的所有人
  const matches = allNames.filter(n => n.toLowerCase().includes(q));

  // 你說「反正就 highlight 全部」：就算很多人也照亮
  select.value = "";
  applyHighlightMany(matches);
});

/* select：選單選單一人（精準 highlight） */
select.addEventListener("change", () => {
  const v = norm(select.value);
  filterInput.value = v;      // 同步填回 input，方便使用者看
  if(!v){
    clearHighlight();
    return;
  }
  applyHighlightMany([v]);
});

/* clear */
clearBtn.addEventListener("click", () => {
  filterInput.value = "";
  select.value = "";
  clearHighlight();
});
</script>

</body>
</html>
